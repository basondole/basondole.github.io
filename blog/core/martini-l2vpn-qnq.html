<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#" class="no-js no-svg">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>

<title>basondole.io &#8211; Professional network design and development</title>

<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link crossorigin="anonymous" rel='stylesheet' id='alia-fonts-css'  href='https://fonts.googleapis.com/css?family=Roboto%3A400%2C400i%2C700%2C700i%7CPoppins%3A400%2C400i%2C700%2C700i&#038;subset=latin%2Clatin-ext' type='text/css' media='all' />


<link rel='stylesheet' id='wp-block-library-css'  href='../../karneliuk/style.min.5.3.2.css' type='text/css' media='all' />
<link rel='stylesheet' id='github-embed-css'  href='../../karneliuk/github-embed.5.3.2.css' type='text/css' media='all' />
<link rel='stylesheet' id='responsive-lightbox-swipebox-css'  href='../../karneliuk/swipebox.min.2.2.2.css' type='text/css' media='all' />
<link rel='stylesheet' id='alia-style-css'  href='../../karneliuk/alia.style.1.35.css' type='text/css' media='all' />
<link rel='stylesheet' id='fontawesome-css'  href='../../karneliuk/all.min.1.0.css' type='text/css' media='all' />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel='stylesheet' id='codecolorer-css'  href='../../karneliuk/codecolorer.0.9.16.css' type='text/css' media='screen' />
<link rel="stylesheet" href="../../css/style1.css" />



<link rel='https://api.w.org/' href='../../karneliuk/wp-json' />


<script type='text/javascript' src='../../karneliuk/jquery-1.12.4-wp.js' class="local-root-js"></script>
<script type='text/javascript' src='../../karneliuk/jquery-migrate.min-1.4.1.js' class="local-root-js"></script>
<script type='text/javascript' src='../../karneliuk/ouibounce-5.3.2.js' class="local-root-js"></script>


<script type="text/javascript">
  window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/svg\/","svgExt":".svg","source":{"concatemoji":"karneliuk/wp-emoji-release.min.5.3.2.js"}};
  !function(e,a,t){var r,n,o,i,p=a.createElement("canvas"),s=p.getContext&&p.getContext("2d");function c(e,t){var a=String.fromCharCode;s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,e),0,0);var r=p.toDataURL();return s.clearRect(0,0,p.width,p.height),s.fillText(a.apply(this,t),0,0),r===p.toDataURL()}function l(e){if(!s||!s.fillText)return!1;switch(s.textBaseline="top",s.font="600 32px Arial",e){case"flag":return!c([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])&&(!c([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!c([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]));case"emoji":return!c([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340])}return!1}function d(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(i=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},o=0;o<i.length;o++)t.supports[i[o]]=l(i[o]),t.supports.everything=t.supports.everything&&t.supports[i[o]],"flag"!==i[o]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[i[o]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(r=t.source||{}).concatemoji?d(r.concatemoji):r.wpemoji&&r.twemoji&&(d(r.twemoji),d(r.wpemoji)))}(window,document,window._wpemojiSettings);
</script>



<meta name="generator" content="WordPress 5.3.2" />

</head>









<body class="home blog sticky_header header_logo_rounded text_posts_unbordered masonry_effect_enabled show_menu_circle_idicator sliding_sidebar_inactive">

<div id="page" class="site">

  <div class="site_main_container">

    <header class="site_header">
      
    <div class="gray_header" style="background-image: url('img/Multivendor_pale.png');" >
      <div class="container site_header">
        <div class="header_square_logo">
          <style>.site_logo_image { width : 120px; }.site_logo_image { height : 120px; }</style>
          <a class="alia_logo retina_logo" title="basondole.io" href="index.html" rel="home">
            <img  width=120 height=120 src="../../img/all-baggy.jpg" class="site_logo img-responsive site_logo_image clearfix" alt="basondole.github.io" /></a>
    
          <a class="alia_logo default_logo  has_retina_logo" title="basondole.io" href="index.html" rel="home">
          <img  width=120 height=120 src="../../img/all-baggy.jpg" class="site_logo img-responsive site_logo_image clearfix" alt="basondole.github.io" /></a>

          <h1 class="screen-reader-text site_logo site-title clearfix">basondole.io</h1>

        </div>

        <div class="header_tagline">
          Network design, development and automation for enterprise and service provider fabrics.
        </div>

        <div class="social_icons_list header_social_icons">
          <a rel="nofollow" target="" href="https://twitter.com/misterbigpaul" title="Twitter" class="social_icon widget_social_icon social_twitter social_icon_twitter"><i class="fa fa-twitter"></i></a>
          <a rel="nofollow" target="_blank" href="https://www.linkedin.com/in/paul-i-2b3013108" title="Linked In" class="social_icon widget_social_icon social_linkedin social_icon_linkedin"><i class="fa fa-linkedin"></i></a>
          <a rel="nofollow" target="_blank" href="https://github.com/basondole" title="Github" class="social_icon widget_social_icon social_github social_icon_github"><i class="fa fa-github"></i></a>

          <a rel="nofollow" target="_blank" href="https://stackoverflow.com/users/12078639/bassosimons" title="stackoverflow" class="social_icon widget_social_icon"><i class="fa fa-rss"></i></a>

        </div>
      </div>

    </div>
        
    <div class="header_nav_wrapper">

      <div class="header_nav">

        <div class="container">
          <div class="site_branding">
          <h1 class="text_logo"><a href="index.html" rel="home">basondole.io<span class="logo_dot"></span></a></h1>
          </div>
          

          <!-- Place header control before main menu if site title is enabled -->
          <div class="header_controls">

            <div class="header_sliding_sidebar_control header_control_wrapper">
              <a id="user_control_icon" class="sliding_sidebar_button" href="#">
                <i class="fa fa-bars header_control_icon"></i>
              </a>
            </div>
        
          </div>
    

          <div class="main_menu">
            <ul id="top-menu" class="navbar">
              <li id="menu-item-318" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-318 default_menu"><a href="index.html" class="local-root-page">Home</a></li>
              
              <li id="menu-item-320" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-320 dropdown default_menu current-menu-item current_page_item active"><a href="../../blog.html" data-hover="dropdown" class="dropdown-toggle" class="local-root-page">Blog</a>
                <ul role="menu" class=" dropdown-menu">
                  <li id="menu-item-424" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-424 default_menu"><a href="index.html">Collaboration</a></li>
                  <li id="menu-item-3124" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3124 default_menu"><a href="../networkauto/index.html">Network Automation</a></li>
                  <li id="menu-item-425" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-425 default_menu"><a href="">Tools</a></li>
                  <li id="menu-item-425" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-425 default_menu"><a href="index.html">Misc</a></li>
                </ul>
              </li>
              <li id="menu-item-2056" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2056 default_menu"><a href="bgp.html" class="local-root-page">BGP</a></li>
              <li id="menu-item-413" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-413 default_menu"><a href="about.html" class="local-root-page">About</a></li>
              
              
            </ul>
            <span class="menu_mark_circle hidden_mark_circle"></span>
          </div>
              
        <!-- Place header control after main menu if site title is enabled -->
          
        </div><!-- end .container -->
      </div><!-- end .header_nav -->
    </div><!-- end .header_nav_wrapper -->
    </header>

    <main id="content" class="site-content">
      <section id="primary" class="container main_content_area">
        <!-- end check for post layout -->
        <div class="row full_width_page_single no_sidebar_post_single">
          <div>
            <!-- <article id="post-182" class="blog_page_container post-182 page type-page status-publish"> -->

              <div class="page_body">
                    <div class="post_info_wrapper">
                      <div class="entry-content blog_page_text blog_page_description">



<!-- ============================ START CONTENT ============================================ -->
<h1 style="text-align: center;">
  <strong>Martini L2VPN with QnQ</strong><strong>.</strong>
</h1>
<h2 id="scenario">Scenario</h2>
<p>An existing client with many service has one interface dedicated (PE1 to CE1) carrying a mix of services vlan-ccc (for layer 2circuit) and routed IP services.<br>The new requirement is that the client wants to have an additional layer 2 circuit to connect CE1 and new site CE3 in which they will be able to add/remove vlans as they wish without service provider intervention (this has to be achieved with no change to current setup). </p>
<h2 id="topology-diagram">Topology diagram</h2>
<p><img width="484" alt="QnQ" src="https://user-images.githubusercontent.com/50369643/61710540-874ad100-ad5a-11e9-9717-8dd383f8df76.png"></p>
<h2 id="configuration">Configuration</h2>
<h4 id="pe-1">PE-1</h4>
<pre><code>root@PE<span class="hljs-number">-1</span>&gt; show configuration routing-instances VPLS 
instance-type vpls;
vlan-id all;
interface ge<span class="hljs-number">-0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">1.5000</span>;
protocols {
    vpls {
        no-tunnel-services;
        vpls-id <span class="hljs-number">1000</span>;
        mesh-group L2CIRC {
            neighbor <span class="hljs-number">10.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span> {
                ignore-encapsulation-mismatch;
            }
        }
    }
}
root@PE<span class="hljs-number">-1</span>&gt; show configuration interfaces ge<span class="hljs-number">-0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">1</span>          
description client-end;
flexible-vlan-tagging;
encapsulation flexible-ethernet-services;
unit <span class="hljs-number">100</span> {
    description <span class="hljs-string">"Sample Existing IP Service"</span>;
    vlan-id <span class="hljs-number">100</span>;
    family inet {
        address <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.1</span>/<span class="hljs-number">30</span>;
    }
}
unit <span class="hljs-number">300</span> {
    description <span class="hljs-string">"Sample Existing Martini L2vpn"</span>;
    encapsulation vlan-ccc;
    vlan-id <span class="hljs-number">300</span>;
    family ccc;
}
unit <span class="hljs-number">5000</span> {
    description <span class="hljs-string">"New Service"</span>;
    encapsulation vlan-vpls;
    vlan-id-range <span class="hljs-number">1001</span><span class="hljs-number">-2000</span>;
    family vpls;
}
</code></pre><h4 id="pe-3">PE-3</h4>
<pre><code>root@PE<span class="hljs-number">-3</span>&gt; show configuration protocols l2circuit 
neighbor <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> {
    interface ge<span class="hljs-number">-0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">2.1000</span> {
        virtual-circuit-id <span class="hljs-number">1000</span>;
        ignore-encapsulation-mismatch;
    }
}

root@PE<span class="hljs-number">-3</span>&gt; show configuration interfaces ge<span class="hljs-number">-0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">2</span>         
flexible-vlan-tagging;
encapsulation flexible-ethernet-services;
unit <span class="hljs-number">1000</span> {
    encapsulation vlan-ccc;
    vlan-id <span class="hljs-number">1000</span>;
    input-vlan-map pop;
    output-vlan-map push;
}
</code></pre><h4 id="gpon-olt">GPON OLT</h4>
<pre><code>GPON-OLT<span class="hljs-meta">#sh run | se interface</span>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">GigabitEthernet0</span>/0</span>
description ETHERNET CONNECTION <span class="hljs-keyword">TO</span> PE-<span class="hljs-number">3</span>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">GigabitEthernet0</span>/2</span>
desciption PON CONNECTION <span class="hljs-keyword">TO</span> ONT

GPON-OLT<span class="hljs-meta">#sh vlan id 1000</span>

VLAN Name          Status    Ports
---- ------------- --------- ---------------------------
<span class="hljs-number">1000</span> VLAN1000      active    Gi0/<span class="hljs-number">0</span>, Gi0/<span class="hljs-number">2</span>
</code></pre><h4 id="mikrotik">MIKROTIK</h4>
<pre><code>[admin@MikroTik] &gt;/interface ethernet
set [ find default-name=ether2 ] comment=<span class="hljs-string">"CONNECTION TO ONU"</span>
set [ find default-name=ether1 ] comment=<span class="hljs-string">"CONNECTION TO CE"</span>

[admin@MikroTik] &gt;/interface vlan <span class="hljs-keyword">add</span><span class="bash"> interface=ether2 name=svlan1000 vlan-id=1000
</span>
[admin@MikroTik] &gt;for vlan <span class="hljs-keyword">from</span> <span class="hljs-number">1001</span> to <span class="hljs-number">2000</span> do={
/interface bridge <span class="hljs-keyword">add</span><span class="bash"> name=(<span class="hljs-string">"vlan-"</span> .<span class="hljs-variable">$vlan</span>. <span class="hljs-string">"-bridge"</span>)
</span>/interface vlan <span class="hljs-keyword">add</span><span class="bash"> interface=ether1 name=(<span class="hljs-string">"cvlan"</span> .<span class="hljs-variable">$vlan</span>) vlan-id=<span class="hljs-variable">$vlan</span>
</span>/interface vlan <span class="hljs-keyword">add</span><span class="bash"> interface=svlan1000 name=(<span class="hljs-string">"vlan-"</span> .<span class="hljs-variable">$vlan</span>. <span class="hljs-string">"-in-1000"</span>) vlan-id=<span class="hljs-variable">$vlan</span>
</span>/interface bridge port <span class="hljs-keyword">add</span><span class="bash"> bridge=(<span class="hljs-string">"vlan-"</span> .<span class="hljs-variable">$vlan</span>. <span class="hljs-string">"-bridge"</span>) interface=(<span class="hljs-string">"vlan-"</span> .<span class="hljs-variable">$vlan</span>. <span class="hljs-string">"-in-1000"</span>)
</span>/interface bridge port <span class="hljs-keyword">add</span><span class="bash"> bridge=(<span class="hljs-string">"vlan-"</span> .<span class="hljs-variable">$vlan</span>. <span class="hljs-string">"-bridge"</span>) interface=(<span class="hljs-string">"cvlan"</span> .<span class="hljs-variable">$vlan</span>)
</span>}
</code></pre><h2 id="verification">Verification</h2>
<h4 id="pe1">PE1</h4>
<pre><code>root@PE-1&gt; show vpls connections | find <span class="hljs-string">"Instance: VPLS"</span>  

Instance: VPLS
  VPLS-id: 1000
  Mesh-group connections: L2CIRC
    Neighbor              Type  St    Time last up          <span class="hljs-comment"># Up trans</span>
    10.2.2.2(vpls-id 1000)   rmt   Up   Jul 23 06:10:55 2019           1
      Remote PE: 10.2.2.2, Negotiated control-word: No
      Incoming label: 262145, Outgoing label: 299776
      Negotiated PW status TLV: No
      Localinterface:lsi.1048576, Status: Up, Encapsulation: ETHERNET
        Description: Intf - vpls VPLS neighbor 10.2.2.2 vpls-id 1000
      Flow Label Transmit: No, Flow Label Receive: No


root@PE-1&gt; show vpls mac-table 

Routing<span class="hljs-built_in"> instance </span>: VPLS
 Bridging domain<span class="hljs-keyword"> :</span> __VPLS__, VLAN<span class="hljs-keyword"> :</span> 1001
   MAC                 MAC      Logical          NH     RTR
   address             flags    interface        Index  ID
   c2:02:7b:9f:00:00   D        ge-0/0/1.5000   
   c2:03:3a:f9:00:01   D        lsi.1048576     


Routing<span class="hljs-built_in"> instance </span>: VPLS
 Bridging domain<span class="hljs-keyword"> :</span> __VPLS__, VLAN<span class="hljs-keyword"> :</span> 1002
   MAC                 MAC      Logical          NH     RTR
   address             flags    interface        Index  ID
   c2:02:7b:9f:00:00   D        ge-0/0/1.5000   
   c2:03:3a:f9:00:01   D        lsi.1048576
</code></pre><h4 id="pe3">PE3</h4>
<pre><code>root@PE-<span class="hljs-number">3</span>&gt; show l2circuit connections interface ge-<span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">2.1000</span> | find <span class="hljs-string">"Neighbor: "</span>
<span class="hljs-symbol">Neighbor:</span> <span class="hljs-number">10.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span>
    Interface                 Type  <span class="hljs-built_in">St</span>     Time last <span class="hljs-meta">up</span>          # <span class="hljs-meta">Up</span> trans
    ge-<span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">2.1000</span>(vc <span class="hljs-number">1000</span>)    rmt   <span class="hljs-meta">Up</span>     Jul <span class="hljs-number">23</span> <span class="hljs-number">06</span>:<span class="hljs-number">10</span>:<span class="hljs-number">55</span> <span class="hljs-number">2019</span>           <span class="hljs-number">1</span>
      Remote PE: <span class="hljs-number">10.1</span><span class="hljs-meta">.1</span><span class="hljs-meta">.1</span>, Negotiated control-<span class="hljs-built_in">word</span>: Yes (Null)
<span class="hljs-symbol">      Incoming label</span>: <span class="hljs-number">299776</span>, Outgoing label: <span class="hljs-number">262145</span>
      Negotiated PW status TLV: No
      Local interface: ge-<span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">2.1000</span>, Status: <span class="hljs-meta">Up</span>, Encapsulation: VLAN
</code></pre><h4 id="gpon-olt">GPON OLT</h4>
<pre><code>GPON-OLT #sh mac add dynamic vlan 1000
<span class="hljs-section">          Mac Address Table
-------------------------------------------</span>

Vlan    Mac Address       Type        Ports
<span class="hljs-bullet">----    </span>-----------       --------    -----
1000    c202.7b9f.0000    DYNAMIC     Gi0/0
1000    c203.3af9.0001    DYNAMIC     Gi0/2
Total Mac Addresses for this criterion: 2
</code></pre><h2 id="testing">Testing</h2>
<h3 id="router-connected-to-ce1">Router connected to CE1</h3>
<pre><code>router<span class="hljs-number">-1</span>#sh run | se interface
interface FastEthernet0/<span class="hljs-number">0</span>
 description CONNECTION TO CE1
 no ip address
interface FastEthernet0/<span class="hljs-number">0.100</span>
 encapsulation dot1Q <span class="hljs-number">100</span>
 ip address <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.2</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.252</span>
interface FastEthernet0/<span class="hljs-number">0.200</span>
 encapsulation dot1Q <span class="hljs-number">200</span>
 ip address <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.0</span>
interface FastEthernet0/<span class="hljs-number">0.1001</span>
 encapsulation dot1Q <span class="hljs-number">1001</span>
 ip address <span class="hljs-number">172.16</span><span class="hljs-number">.16</span><span class="hljs-number">.1</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.248</span>
interface FastEthernet0/<span class="hljs-number">0.1002</span>
 encapsulation dot1Q <span class="hljs-number">1002</span>
 ip address <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.1</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.248</span>
interface FastEthernet0/<span class="hljs-number">0.1003</span>
 encapsulation dot1Q <span class="hljs-number">1003</span>
 ip address <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.1</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.252</span>
</code></pre><h3 id="router-connected-to-ce3">Router connected to CE3</h3>
<pre><code>router<span class="hljs-number">-2</span>#sh run | se interface
interface FastEthernet0/<span class="hljs-number">1</span>
 description CONNECTION TO CE3
 no ip address
interface FastEthernet0/<span class="hljs-number">1.1001</span>
 encapsulation dot1Q <span class="hljs-number">1001</span>
 ip address <span class="hljs-number">172.16</span><span class="hljs-number">.16</span><span class="hljs-number">.2</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.248</span>
interface FastEthernet0/<span class="hljs-number">1.1002</span>
 encapsulation dot1Q <span class="hljs-number">1002</span>
 ip address <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.2</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.248</span>
interface FastEthernet0/<span class="hljs-number">1.1003</span>
 encapsulation dot1Q <span class="hljs-number">1003</span>
 ip address <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.2</span> <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.252</span>
</code></pre><h4 id="results-of-ping-from-router-1-to-router-2-on-different-test-vlans">Results of ping from router-1 to router-2 on different test vlans</h4>
<pre><code>router<span class="hljs-number">-1</span>#sh arp
Protocol  Address      Age Hardware Addr   Type Interface
Internet  <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.1</span>    -  c202<span class="hljs-number">.7</span>b9f<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">0.1003</span>
Internet  <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.2</span>    <span class="hljs-number">52</span> c203<span class="hljs-number">.3</span>af9<span class="hljs-number">.0001</span>  ARPA  FastEthernet0/<span class="hljs-number">0.1003</span>
Internet  <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.1</span>   -  c202<span class="hljs-number">.7</span>b9f<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">0.1002</span>
Internet  <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.2</span>   <span class="hljs-number">87</span> c203<span class="hljs-number">.3</span>af9<span class="hljs-number">.0001</span>  ARPA  FastEthernet0/<span class="hljs-number">0.1002</span>
Internet  <span class="hljs-number">172.16</span><span class="hljs-number">.16</span><span class="hljs-number">.1</span>  -  c202<span class="hljs-number">.7</span>b9f<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">0.1001</span>
Internet  <span class="hljs-number">172.16</span><span class="hljs-number">.16</span><span class="hljs-number">.2</span>  <span class="hljs-number">37</span> c203<span class="hljs-number">.3</span>af9<span class="hljs-number">.0001</span>  ARPA  FastEthernet0/<span class="hljs-number">0.1001</span>
Internet  <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>  -  c202<span class="hljs-number">.7</span>b9f<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">0.200</span>
Internet  <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.2</span> -  c202<span class="hljs-number">.7</span>b9f<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">0.100</span>
</code></pre><pre><code>router<span class="hljs-number">-2</span>#sh arp
Protocol  Address    Age  Hardware Addr   Type   Interface
Internet  <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.1</span>   <span class="hljs-number">55</span>  c202<span class="hljs-number">.7</span>b9f<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">1.1003</span>
Internet  <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.2</span>   -   c203<span class="hljs-number">.3</span>af9<span class="hljs-number">.0001</span>  ARPA  FastEthernet0/<span class="hljs-number">1.1003</span>
Internet  <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.1</span>  <span class="hljs-number">90</span>  c202<span class="hljs-number">.7</span>b9f<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">1.1002</span>
Internet  <span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.2</span>  -   c203<span class="hljs-number">.3</span>af9<span class="hljs-number">.0001</span>  ARPA  FastEthernet0/<span class="hljs-number">1.1002</span>
Internet  <span class="hljs-number">172.16</span><span class="hljs-number">.16</span><span class="hljs-number">.1</span> <span class="hljs-number">40</span>  c202<span class="hljs-number">.7</span>b9f<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">1.1001</span>
Internet  <span class="hljs-number">172.16</span><span class="hljs-number">.16</span><span class="hljs-number">.2</span> -   c203<span class="hljs-number">.3</span>af9<span class="hljs-number">.0001</span>  ARPA  FastEthernet0/<span class="hljs-number">1.1001</span>
Internet  <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span> -   c203<span class="hljs-number">.3</span>af9<span class="hljs-number">.0000</span>  ARPA  FastEthernet0/<span class="hljs-number">0.200</span>
</code></pre><h4 id="packet-capture-of-ping-from-router-2-to-router-1-on-internal-vlan-1003">Packet capture of ping from router-2 to router-1 on internal vlan 1003</h4>
<p>Frame has one tag as it goes from router-2 to Mikrotik</p>
<p><img src="https://user-images.githubusercontent.com/50369643/61712701-92543000-ad5f-11e9-914c-d6e08496ea9d.png" alt="pcap-r2-to-mk"></p>
<p>Mikrotik assigns a seconds tag and sends the frame towards PE-3 with two vlan tags</p>
<p><img src="https://user-images.githubusercontent.com/50369643/61712671-80728d00-ad5f-11e9-904a-f28406efb75d.png" alt="pcap-mk-to-pe3"></p>
<h1 id="troubleshooting">Troubleshooting</h1>
<p>Checking the mac-address table on the PE with VPLS instance</p>
<pre><code>root@PE-1&gt; show vpls mac-table<span class="hljs-built_in"> instance </span>VPLS vlan 1001

Routing<span class="hljs-built_in"> instance </span>: VPLS
 Bridging domain<span class="hljs-keyword"> :</span> __VPLS__, VLAN<span class="hljs-keyword"> :</span> 1001
   MAC                 MAC      Logical          NH     RTR
   address             flags    interface        Index  ID
   c2:02:7b:9f:00:00   D        ge-0/0/1.5000   
   c2:03:3a:f9:00:01   D        lsi.1048576
</code></pre><p>To delete the cvlans added by the script in Mikrotik use below script</p>
<pre><code>[admin@MikroTik] &gt; <span class="hljs-keyword">for</span> <span class="hljs-keyword">x</span> from <span class="hljs-number">1001</span> <span class="hljs-keyword">to</span> <span class="hljs-number">2000</span> <span class="hljs-keyword">do</span>={
/<span class="hljs-keyword">int</span> bridge port {<span class="hljs-built_in">remove</span> [<span class="hljs-keyword">find</span> bridge=(<span class="hljs-string">"vlan-"</span> .$<span class="hljs-keyword">x</span>. <span class="hljs-string">"-bridge"</span>)]}
/<span class="hljs-keyword">int</span> bridge {<span class="hljs-built_in">remove</span> [<span class="hljs-keyword">find</span> name=(<span class="hljs-string">"vlan-"</span> .$<span class="hljs-keyword">x</span>. <span class="hljs-string">"-bridge"</span>)]}
/<span class="hljs-keyword">int</span> vlan {<span class="hljs-built_in">remove</span> [<span class="hljs-keyword">find</span> name=(<span class="hljs-string">"cvlan"</span> .$<span class="hljs-keyword">x</span>)]}
/<span class="hljs-keyword">int</span> vlan {<span class="hljs-built_in">remove</span> [<span class="hljs-keyword">find</span> name=(<span class="hljs-string">"vlan-"</span> .$<span class="hljs-keyword">x</span>. <span class="hljs-string">"-in-1000"</span>)]}
}
</code></pre><h5 id="note">Note</h5>
<p>To delete every bridge interface<br><code>[admin@MikroTik] &gt;inter bri {remove [find]}</code></p>
<p>To delete every vlan interface<br><code>[admin@MikroTik] &gt;int vla {remove [find]}</code></p>



                      </div>
                    </div>
                    <!-- end post_info_wrapper -->
                  </div>
                  <!-- end post_body -->

                </article>

<!-- ============================ END CONTENT ============================================ -->

                <div class="author_info_container author_single_box">
                  <div class="row">
                    <div class="author_avatar_col col">
                      <a class="author_avatar_url" href="about"><img alt='' src='../../img/all-baggy.jpg' srcset='../../img/all-baggy.jpg' class='avatar avatar-150 photo' height='150' width='150' /></a>
                    </div>
                    <div class="author_info_col col">
                      <div class="author_box_info_header">
                        <h2 class="author_display_name title">
                          <a class="author_name_url url fn n" href="">Paul S.I. Basondole </a>
                        </h2>

                      </div>
                      <div class="author_description">
IT &amp; Network Expert / Lead <br>
Network & Automation designer; <br>
2x JNCIP (RS/SP) 1x CCNP (RS) <br>
BSc Telecommunications Eng.
                      </div>
                      <div class="stories_circles_wrapper"></div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- close col12 just inside .full_width_list -->
            </div>
            <!-- close .full_width_list -->
            <!-- close col and row in case of sidebar layout -->
            <!-- end check for post layout -->
          </section>
          <!-- #primary -->
        </main>
        <!-- #content -->
        <footer id="colophon" class="site_footer container" role="contentinfo">
          <div class="footer_credits footers_active_sidebars_0">
            &copy; 2020 basondole.io
          </div>
          <div id="aliagototop" title="Scroll To Top" class="alia_gototop_button footer_button">
            <i class="fa fa-arrow-up"></i>
          </div>
        </footer>

        <!-- #colophon -->
      </div>
      <!-- .site_main_container -->
      <!-- start sliding sidebar content -->
     <!-- .site_main_container -->
      <!-- start sliding sidebar content -->
      <div class="sliding_close_helper_overlay"></div>
      <div class="site_side_container">
        <h3 class="screen-reader-text">
          Sliding Sidebar
        </h3>
        <div class="info_sidebar">
          <div class="top_header_items_holder mobile_menu_opened">
            <div class="main_menu">
              <ul id="mobile-menu" class="navbar">
                <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-318 default_menu">
                  <a href="index.html" class="local-root-page">Home</a>
                </li>
                <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2788 default_menu">
                  <a href="https://github.com/basondole/mpls#introduction">Design</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2534 default_menu">
                  <a href="https://github.com/basondole/open#hocid">NET2CODE</a>
                </li>
                <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-320 dropdown default_menu">
                  <a href="blog.html" data-hover="dropdown" class="dropdown-toggle" class="local-root-page">Blog</a>
                  <ul role="menu" class=" dropdown-menu">
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-424 default_menu">
                      <a href="index.html">Collaboration</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-3124 default_menu">
                      <a href="../networkauto/index.html">Network Automation</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-425 default_menu">
                      <a href="https://github.com/basondole/tutorials">Network Servers</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-425 default_menu">
                      <a href="https://github.com/basondole/netmanagement">Misc</a>
                    </li>
                  </ul>
                </li>
                <li id="menu-item-2056" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2056 default_menu"><a href="bgp.html" class="local-root-page">BGP</a></li>
                <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-413 default_menu current-menu-item current_page_item active">
                  <a href="about.html" class="local-root-page">About</a>
                </li>
                <li class="menu-item menu-item-type-post_type menu-item-object-page page_item page-item-145 menu-item-412 default_menu">
                  <a href="contact.html" class="local-root-page">Contact</a>
                </li>
                
                </li>
              </ul>
            </div>
          </div>
          <!-- end .top_header_items_holder -->
        </div>
      </div>
      <!-- end sliding sidebar content -->
      <!-- start footer static content -->
      <!-- start footer static content -->
    </div>
    <!-- #page -->
    <div id="ajax_modal_story" class="ajax_modal ajax_modal_story modal enable_rotate">
      <div class="story_modal_overlay_helper"></div>
    </div>


    </script>

    <script type='text/javascript' src='../../karneliuk/global.1.35.js' class="local-root-js"></script>


    <script type='text/javascript'>
/* <![CDATA[ */
var alia_core_vars = { "ajax_load_story": "http:\/\/karneliuk.com\/wp-content\/plugins\/alia-core\/ajax-load-story.php", "ajax_rotate_story": "http:\/\/karneliuk.com\/wp-content\/plugins\/alia-core\/ajax-rotate-story.php" };
/* ]]> */
    </script>


    <script type='text/javascript' src='../../karneliuk/alia-core.1.13.js' class="local-root-js"></script>
    <script type='text/javascript' src='../../karneliuk/wp-embed.min.5.3.2.js' class="local-root-js"></script>

    
<script type="text/javascript">
  // edit the level variable, the load the page and copy the loaded DOM, NOT the source
  // to get updated paths throughout the dom
  
  var 
  localPagesFiles = document.getElementsByClassName("local-root-page"),
  localJsFiles = document.getElementsByClassName("local-root-js"),
  localCssFiles = document.getElementsByClassName("local-root-css"),
  localImagesFiles = document.getElementsByClassName("local-root-image");

  var level = "../../";

  function updatePaths() { 
    for (var i=0; i<localPagesFiles.length; i++) {
          var path = level + localPagesFiles[i].getAttribute("href");
          localPagesFiles[i].setAttribute("href",path);
          console.log(localPagesFiles[i].getAttribute("href"));
    }

    for (var i=0; i<localJsFiles.length; i++) {
          var path = level + localJsFiles[i].getAttribute("src");
          localJsFiles[i].setAttribute("src",path);
          console.log(localJsFiles[i].getAttribute("src"));
    }

    for (var i=0; i<localCssFiles.length; i++) {
          var path = level + localCssFiles[i].getAttribute("src");
          localCssFiles[i].setAttribute("src",path);
          // console.log(localJsFiles[i].getAttribute("src"));
    }

    for (var i=0; i<localImagesFiles.length; i++) {
          var path = level + localImagesFiles[i].getAttribute("src");
          localImagesFiles[i].setAttribute("src",path);
          // console.log(localJsFiles[i].getAttribute("src"));
    }
  }

  window.onload = function () {
   updatePaths();
  };

</script>

<script type="text/javascript">
  var localPagesFiles = document.getElementsByClassName("local-root-page");
function printId(event) {
  var myId = this.Id;
  console.log(myId);
}
for (var i=0; i<localPagesFiles.length; i++) {
       localPagesFiles[i].addEventListener("click",printId);
}
</script>




  </body>
</html>
